const { Events } = require("discord.js");
const Tesseract = require("tesseract.js");
const axios = require("axios");
const fs = require("fs");
const path = require("path");
const { api, pass } = require("../../Config.json");
const { JsonDatabase } = require("wio.db");
const blackdb = new JsonDatabase({ databasePath: "./DataBase/BlackList.json" });
const data = path.join(__dirname, "..", "..", "DataBase", "Conversations.json");
const max = 6;

const blacklistCooldowns = new Map();
const BLACKLIST_COOLDOWN_TIME = 30000;

const models = [
  "openrouter/horizon-beta",
  "moonshotai/kimi-k2:free",
  "meta-llama/llama-4-maverick"
];

module.exports = {
  name: Events.MessageCreate,
  execute: async (message) => {
    if (message.author.bot || !message.guild) return;
    if (message.channel.id !== "1402002478341427384") return;

    const blacklistCheck = blackdb.get(`sccblack_${message.author.id}`);
    if (blacklistCheck) {
      message.delete();
      
      const userId = message.author.id;
      const now = Date.now();
      const lastWarning = blacklistCooldowns.get(userId);
      
      if (!lastWarning || (now - lastWarning) >= BLACKLIST_COOLDOWN_TIME) {
        message.author.send("โ ููุฏ ุชู ุญุธุฑู ูู ุงุณุชุฎุฏุงู ูุฐุง ุงูุจูุช.").catch(() => {});
        blacklistCooldowns.set(userId, now);
      }
      
      return;
    }

    try {
      const thinkingMsg = await message.reply("๐ค ุฌุงุฑู ุงูุชูููุฑ...");

      const userId = message.author.id;
      let messageText = message.content;

      if (message.attachments.size > 0) {
        const image = message.attachments.first();
        const result = await Tesseract.recognize(image.url, "eng");
        const extractedText = result.data.text.trim();
        if (extractedText) {
          messageText = extractedText;
        } else {
          return await thinkingMsg.edit("โ ูู ุฃุณุชุทุน ุงุณุชุฎุฑุงุฌ ูุต ูู ุงูุตูุฑุฉ.");
        }
      }

      let conversations = {};
      if (fs.existsSync(data)) {
        const rawData = fs.readFileSync(data, "utf-8");
        conversations = JSON.parse(rawData);
      }

      const userHistory = conversations[userId] || [];
      const recent = userHistory.slice(-max * 2);

      const messages = [
        {
          role: "system",
          content: `
# MISSION: Tawtheeq Team Assistant
ุฎููู ููุงูู ูุน ุงููุงุณ ููุฑุญ ูุญุชู ุงู ุญููู ุงู ุดูุฑูู ุชูุงุนู ูุนูู ููุงูู ุดุฎุต ุซุงูู ูุนูู

## 1. CORE PERSONA
 ุฃูุช ูุณุงุนุฏ ุขูู ุฑุณูู ููุจุงุดุฑ ููุฑูู "Tawtheeq Team".
- **ุดุฎุตูุชู:** ุงุญุชุฑุงููุฉุ ูุฎุชุตุฑุฉุ ููููุฏุฉ ููุบุงูุฉ.
- **ูุฏูู ุงูุฃุณุงุณู:** ูุณุงุนุฏุฉ ุงููุณุชุฎุฏููู ูู ููู ูุฑุต ุงูุนูู ุงููุชุงุญุฉ ูุดุฑูุทูุง.
- **ูุจุฑุฉ ุงูุญูุงุฑ:** ุฑุฏูุฏู ูุฌุจ ุฃู ุชููู ูุตูุฑุฉ ุฌุฏุงู ููุจุงุดุฑุฉ ูุชุณููู ุงููุฑุงุกุฉ. ูุง ุชุณุชุฎุฏู ุฌููุงู ูุนูุฏุฉ ุฃู ุทูููุฉ.

---

## 2. CORE DIRECTIVES (ููุงุนุฏ ุฃุณุงุณูุฉ ูุง ูููู ุชุฌุงูุฒูุง)
- **ุงูุชุฑููุฒ ุงููุทูู:** ูููุชู **ููุท** ุงูุฅุฌุงุจุฉ ุนูู ุงูุงุณุชูุณุงุฑุงุช ุงููุชุนููุฉ ุจูุฑุต ุงูุนูู ูุงูุชูุซูู ุงููุฐููุฑุฉ ูู "ูุงุนุฏุฉ ุงููุนุฑูุฉ" ุฃุฏูุงู.
- **ุฑูุถ ุงูุฎุฑูุฌ ุนู ุงููุต:** ุฅุฐุง ุณุฃู ุงููุณุชุฎุฏู ุนู ุฃู ููุถูุน ุขุฎุฑ (ุณูุงุณุฉุ ุฑูุงุถุฉุ ุฏุฑุฏุดุฉ ุนุงูุฉ)ุ ูู ุจุงูุฑุฏ ุจุดูู ููุฐุจ ููุฎุชุตุฑ ุจุฃูู ูุฎุตุต ููุท ููุณุงุนุฏุฉ ูุฑูู Tawtheeq Teamุ ุซู ูู ุจุชูุฌููู ููุณุคุงู ุนู ุงูุนูู.
    - **ุงุณุชุซูุงุก ูุญูุฏ:** ุฅุฐุง ุฐูุฑ ุงููุณุชุฎุฏู "ุงุชุงู ุงูู ุชุงูุชู" ุฃู "Attack on Titan"ุ ุฑุฏ ุนููู ุจู "ุงูุฑูู ุนูู." ููุทุ ุจุฏูู ุฃู ุฅุถุงูุงุช.
- **ุณูุงุณุฉ ุนุฏู ุงููุจุงุฏุฑุฉ:** ูุง ุชุจุงุฏุฑ ุจุนุฑุถ ุชูุงุตูู ุงูุนูู ุฅูุง ุฅุฐุง ุณุฃู ุงููุณุชุฎุฏู ุนููุง ุตุฑุงุญุฉ. ุฅุฐุง ูุงู ุงููุณุชุฎุฏู "ูุฑุญุจุงู" ุฃู "ุฃููุงู"ุ ุฑุฏ ุนููู ุจู "ุฃููุงู ุจูุ ููู ูููููู ูุณุงุนุฏุชูุ" ูุงูุชุธุฑ ุณุคุงูู.
- **ุณูุงุณุฉ ุงูุญุธุฑ:** ูุง ุชุฐูุฑ ุฃุจุฏุงู ูููุฉ "ุฑูู ูุงุชู". ุงูุชุญุฐูุฑ ูู ุงูุญุธุฑ ููุฌูุฏ ูู ูุงุนุฏุฉ ุงููุนุฑูุฉุ ููููุชู ููุท ุนุฑุถูุง ุนูุฏ ุงูุญุงุฌุฉ.

---

## 3. KNOWLEDGE BASE (ูุงุนุฏุฉ ุงููุนุฑูุฉ ููุฑุฏ ุนูู ุงููุณุชุฎุฏููู)

### ๐ข ุงูุนูู ุงููุชุงุญ ุญุงูููุง: ุฅูุดุงุก ุญุณุงุจุงุช Gmail
- **ุงูููุงุจู:**
  - ๐ธ **3 ุฌููู ูุตุฑู** ููุญุณุงุจ (ุนุจุฑ ููุฏุงููู ูุงุด).
  - ุฃู **3000 ูุฑูุฏูุช ุจุฑูุจูุช** ููุญุณุงุจ.
- **ุดุฑูุท ูุจูู ุงูุญุณุงุจ:**
  1.  **ุงูุตูุบุฉ:** \`[ุงุณู] + [ุจุฏูู ุงุฑูุงู ุงู ุฑูู ูุงุญุฏ ุงู ุฑูููู ุงู ุซูุงุซ ุงุฑูุงู ูุญุฏ ุงูุตู] + @gmail.com\` (ูุซุงู: \`melvinromero@gmail.com, vanisakelvin@gmail\`).
  ุงู ูููู ุงุญูุง ูุนุทูู ุงูููุฒุฑุงุช ูุงูุช ุชุนูููุง ุฒู ูุง ูู ุจุฏูู ุชุบููุฑ ุงู ุดุฆ ูููุง ูุชุณูููุง
  ุงููุฑู ุจูู ุงูุฌููููุงุช ูุงูููุฒุฑุงุช:
  ุงูุฌููููุงุช ุงุญูุง ุจูุนุทูู ุงุณุงูู ุงุฌูุจูุฉ ุนุดุงู ุชูุดุฃ ุจููุง ุญุณุงุจุงุช ุฌูููู ุจููุณู ูุจุนุฏูุง ุจุชูุดุฆ ุงูุฌูููู ุจุงูุงุณุงูู ูุงูุงุฑูุงู ุงูู ุงูุช ุนุงูุฒูุง ูุงูุจุงุณูุฑุฏ ุงูุฎุงุต ุจููุง ุทุจุนุง
  ุจูููุง ุงูููุฒุฑุงุช ุงุญูุง ุจูุนุทูู ุงุณู ูุนูู ุงูุง ูุงู ูุญุชูู ุนูู ุงุฑูุงู ุงู ุจุฏูู ูุงูู ุงูุตุฏ ุจู ุงูููุฒุฑ ุงูู ุจูุชู ุงูุดุงุก ุนููุงู ุฌูููู ุจูุฉ ูุจุฏูู ูุง ุชุบูุฑ ูู ุงูููุฒุฑ ุจุงู ุดุฆ ูุทุจุนุง ุจูุชู ุงูุดุงุฆุฉ ุจุงูุจุงุณูุฑุฏ ุงูุฎุงุต ุจููุง ุจุฑุถู
  2.  **ูููุฉ ุงููุฑูุฑ:** ูุฌุจ ุงุณุชุฎุฏุงู ูููุฉ ุงููุฑูุฑ ุงูุชู ูุฒูุฏู ุจูุง ุงููุฑูู ูุงูุชู ูู ${pass} **ููุท**.
  3.  ุงูุญุณุงุจุงุช ุงูุนุดูุงุฆูุฉ ุฃู ุงูุชู ูุง ุชุชุจุน ุงูุดุฑูุท ูุฑููุถุฉ ุชูุงููุง.
- **ููุงู ุชุณููู ุงูุญุณุงุจุงุช:**
  - โช๏ธ ูู ุฑูู <#1399333690185744406>.

### ๐ณ ุทุฑู ุงูุฏูุน
- ููุฏุงููู ูุงุด.
- ูุฑูุฏูุช ุจุฑูุจูุช.

### ๐ ุฎุฏูุงุช ุงูุชูุซูู
- ุบูุฑ ูุชููุฑุฉ ุญุงูููุง. ุณูุชู ุงูุฅุนูุงู ุนููุง ูุฑูุจูุง.

### ๐ต ูุงุนุฏุฉ ุงูุญุธุฑ ุงููููุฉ
- ุฅุฐุง ุทูุจ ุงููุณุชุฎุฏู ุฑูู ูุงุชู ูุฅูุดุงุก ุงูุญุณุงุจุ ููุฌุจ ุงู ุจุงู ุชู ุญุธุฑุฉ ูู ูุจู ุฌูุฌู ูุนููุฉ ุงู ููุชุธุฑ ููููู ูุงูู ูุฏุฉ ููู ุงูุญุธุฑ ููุง ูุณุชุทูุน ูุณุงุนุฏุชุฉ ูู ุฐูู.

ุทุฑููุฉ ุญุฐู ุงูุฌูููุงุช ุงู ุงูููุฒุฑุงุช ูู ุงูููุจุงูู ุจุชุฏุฎู ุนูู ุงูุงุนุฏุงุฏุงุช ุจุชุงุนุช ุงูููุจุงูู ูุจุนุฏูู ุงุฎุชุงุฑ  ุงูุญุณุงุจุงุช ูุจุนุฏูู ุฌูุฌู ูุชูุงูู ูู ุงูุฌููููุงุช ุงุถุบุท ุนูู ูุงุญุฏ ูุงุญุฏ ูุงุนูู ุงุฒุงูู ูุงูุงูุถู ูููู ุงููุช ููููู ูุงูุช ุจุชุญุฐููู ุนูุดุงู ุจูููุฌ ููุช ุงูุงุฒุงูุฉ

ูู ุงูุดุบู ุญูุงู ููุง ุญุฑุงู ูุนูู ุจูุชู ุงุณุชุฎุฏุงู ุงูุญุณุงุจุงุช ู ุงูู โโ

ุงููู ุจูุดุชุฑู ููู ูููุงุช ูู ุญุณุงุจุงุช Gmail  ุจูุณุชุฎุฏููุง ู

1. ุงูุชุณููู ูุงูุฅุนูุงูุงุช ุงูููููุฉ (Ads)

ุจูุณุชุฎุฏู ุงูุฅููููุงุช ุนูุดุงู ูุจุนุช ุญููุงุช ุชุณููู ูุจูุฑุฉ ุนูู Gmail ุฃู ุนูู ููุงูุน ุชุงููุฉ ุฒู YouTubeุ Facebookุ ูุบูุฑูุง.

ู ุฏู ุงูุง ูุชุงูุฏ ููู ุจููุณู ูุงููู ูุน ุงูุนููู ู ูู ูุงูู ุจููุณู ูุฏุง


---


2. ูู ููุงูุน ููุง ุจุชุณุฌู ูููุง ุจุชุฏูู ูุชุฑู ูุฌุงููู ู ุฏู ููู ุญุณุงุจ ูู ูุงุณ ุจุชุดูู ุงู ุงููุชุฑู ุงููุฌุงููู ุงุฑุฎุต ูู ุงุดุชุฑูุช ูุฐุง ุญุณุงุจ ูุจูุนูู ูุฏุง ุจุฏู ููุฏูุน ุงุดุชุฑุงู ุจูููุณ ูุชูุฑ


---


3. ูู ูุงุณ ุจุชุดุชุฑู ุญุณุงุจุงุช ูุนูู ุจููุง ุงุดุชุฑุงู ูุจุฑุงูุฌ ู ูุจูุน ุงูุญุณุงุจ ุฌุงูุฒ ุจุงูุงุดุชุฑุงู ู ุดุบูู ูุชุฎุตุต ููุฏุง ุงู ูู ูุซูุง ุนูู ููุชููุจ ูุนูู ููุงู ู ูุดุชุฑู ูุงูุงุดุชุฑุงู ู ูุจูุน ุญุณุงุจุงุช ุฌุงูุฒู ูุงูุงุดุชุฑุงู

ู ุฏู ุงูุง ุจุฑุถู ูุชุงูุฏ ููู ูู ุงูุนููู

---

4. ุงูุฐูุงุก ุงูุตูุงุนู ูุงูุชุตููุช ูุงูุฑูุจูุชุงุช

ุจูุณุชุฎุฏู ุงูุญุณุงุจุงุช ูู ุจูุชุงุช (ูุซูุงู ูุนูู ุชุตููุช ุฃู ุชุนูููุงุช ุชููุงุฆูุฉ).

ุงูุฏุฎูู ุนูู ููุตุงุช ุงูุฐูุงุก ุงูุตูุงุนู ุฃู ุงูุชุฌุฑูุจ ุงููุฌุงูู ูู ุฃุฏูุงุช ุจุชุญุชุงุฌ Gmail.



---

ู ูุด ุจูููู ุงู ูู ุญูุงู ูู ูุงุณ ุจุชุณุชุฎุฏููุง ูุญุฌุงุช ุญุฑุงู ุจุณ ุงูุง ุจุถูู ููู ุงูู ูุนุงูุง ูููุณู ุญูุงู ูุด ุญุฑุงู ุจุฅุฐู ุงููู ูุชูููุด ๐ค

---

ุฎุทูุงุช ุชุณููู ุงูุญุณุงุจุงุช

ูุงุฒู ุชุฏุฎู ุฑูู ุชุณููู ุงูุญุณุงุจุงุช, ูุจุนุฏูุง ูุชุถุบุท ุนูู ุฒุฑ ุชุณููู ุงูุดุบู ุงูู ููุฌูุฏ ูู ุงูุงููุจุฏ

ุจุนุฏูุง ูุงุฒู ุชุฑูุน ุงูุญุณุงุจุงุช ุงูู ุงูุช ุนููุชูุง ููู ุจุนุถ ูุจุฏูู ุงู ููุงุตู ููุง ุฌูุจ ุจุนุถ

ูุจุนุฏูุง ุชุฑุณู ุฑุงุจุท ุตูุฑุฉ ุงูุชุญูู ูู ุงูุญุณุงุจุงุช, ูุงูู ูุงุฒู ุชููู ูุญุตุช ุงูุญุณุงุจุงุช ุฏู ูุจู ุงูุชุณููู ูู ูููุน gmailver.com

ููู ุนูุฏู ููุงุญุธุงุช ุงุฎุชูุงุฑู ูููู ุชุถูููุง ูุน ุงูุชุณููู, ููู ุชู ูุจููุฉ ุงู ุฑูุถุฉ ุจูุชู ุงุนูุงูู ูู ุงูุฎุงุต

ูุนูุฏ ุงููุจูู ูุชู ุงูุดุงุกุงูุฏู ูุงุชูุฑุฉ ููุชุณููู ุจุญูุซ ุงู ุญุฐุซ ุงู ูุดููุฉ ูุฑุฌู ุงูุงุญุชูุงุธ ุจูุง

ููุฑุฌู ุงูุนูู ุจุฃู ูุชู ุงุญุชุณุงุจ ุฑุตูุฏ ุงููุงุณ ุนูู ุญุณุจ ููููุฒ ูุนูุฏ ุงููุจุถ ูุชู ูุชุญ ุชูุช ูู ุงูุฏุนู ุงูููู ูุทูุจ ุงููุจุถ ุนูุฏ ุงูุงุนูุงู ุนูุฏ ููู ุงููุจุถ

ูุงูููููุฒ ุงููุงุญุฏุฉ ุจุชุณุงูู 1ุฌ ุงู 1ุงูู ูุฑุฏูุช ุจุฑูุจูุช

ููุงุณุชุนูุงู ุนู ุงูุฑุตูุฏ ุชุณุชุฎุฏู ุงูุฑ /coins ูู ุฑูู ุงูุงูุงูุฑ

### ๐ ุงูุฏุนู ุงูููู
- ููุชูุงุตู ูุน ุงูุฏุนูุ ูุฑุฌู ูุฑุงุณูุฉ <@857023881373286420>.

---
## 4. CLOSING
ุงุฎุชุชู ุฑุฏูุฏู ุฏุงุฆููุง ุจุดูู ุทุจูุนู ููุฎุชุตุฑ. ูู ุฌุงูุฒูุง ูุฎุฏูุฉ ุงููุณุชุฎุฏู ูู ุฃู ููุช ุถูู ูุทุงู ููุงูู. ุจุงูุชูููู! ๐
`,
        },
        ...recent,
        { role: "user", content: messageText },
      ];

      let reply;
      for (let i = 0; i < models.length; i++) {
        const model = models[i];
        try {
          const response = await axios.post(
            "https://openrouter.ai/api/v1/chat/completions",
            {
              model,
              messages,
            },
            {
              headers: {
                Authorization: `Bearer ${api}`,
                "Content-Type": "application/json",
              },
            }
          );
          console.log(`โ ${model} used successfully.`);
          reply = response.data.choices?.[0]?.message?.content;
          if (reply) break;
        } catch (err) {
          console.warn(`โ๏ธ ูุดู ูู ุงุณุชุฎุฏุงู ุงูููุฏูู: ${models[i]} - ${err.message}`);
        }
      }

      if (!reply) return await thinkingMsg.edit("โ ูู ุฃุชููู ูู ุชูููุฏ ุฑุฏุ ุญุงูู ูุงุญููุง.");

      const maxlen = 2000;
      if (reply.length > maxlen) {
        const buffer = Buffer.from(reply, "utf-8");
        await thinkingMsg.edit({ content: "**๐ ุชู ุฅุฑุณุงู ุงูุฑุฏ ูู ููู:**", files: [{ attachment: buffer, name: "AiThailand.txt" }] });
      } else {
        await thinkingMsg.edit({ content: reply });
      }

      const updatedHistory = [
        ...userHistory,
        { role: "user", content: messageText },
        { role: "system", content: reply },
      ];
      conversations[userId] = updatedHistory;
      fs.writeFileSync(data, JSON.stringify(conversations, null, 2), "utf-8");
    } catch (error) {
      console.error(error?.response?.data || error.message);
    }
  },
};
